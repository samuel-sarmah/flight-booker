<% content_for :title, "Book Your Flight" %>

<!-- Hero Section -->
<header class="hero">
  <h1 class="hero__title">Book Your Flight</h1>
  <p class="hero__subtitle">
    Find and book your perfect flight for your journey. Simple, fast, and elegant.
  </p>
</header>

<!-- Quick Links Section -->
<div class="card mb-xl" style="max-width: 600px; margin-left: auto; margin-right: auto;">
  <div class="card__header">
    <h3 class="card__title">Already have a booking?</h3>
    <p class="card__subtitle">Find your existing booking with reference and email</p>
  </div>
  <div class="card__body">
    <div class="flex gap-md">
      <%= link_to "Find Booking", lookup_bookings_path, class: "btn btn-secondary" %>
      <%= link_to "Continue as Guest", flights_path, class: "btn btn-ghost" %>
    </div>
  </div>
</div>

<!-- Progress Steps -->
<nav class="progress-steps" aria-label="Booking progress">
  <div class="progress-step progress-step--active">
    <span class="progress-step__number">1</span>
    <span class="progress-step__label">Search</span>
  </div>
  <div class="progress-step__divider"></div>
  <div class="progress-step">
    <span class="progress-step__number">2</span>
    <span class="progress-step__label">Passengers</span>
  </div>
  <div class="progress-step__divider"></div>
  <div class="progress-step">
    <span class="progress-step__number">3</span>
    <span class="progress-step__label">Confirm</span>
  </div>
</nav>

<!-- Search Form -->
<%= form_with url: flights_path, method: :get, local: true, class: "search-form", 
              data: { controller: "flight-search", turbo_frame: "flight-results" } do |f| %>
  
  <div class="search-form__grid">
    <div class="form-group">
      <%= f.label :departure_airport_id, "From", class: "form-label" %>
      <%= f.select :departure_airport_id, @airport_options, 
          { include_blank: "Select departure" },
          { class: "form-select form-input", 
            data: { flight_search_target: "departure", action: "change->flight-search#validate" } } %>
    </div>

    <div class="form-group">
      <%= f.label :arrival_airport_id, "To", class: "form-label" %>
      <%= f.select :arrival_airport_id, @airport_options, 
          { include_blank: "Select destination" },
          { class: "form-select form-input", 
            data: { flight_search_target: "arrival", action: "change->flight-search#validate" } } %>
    </div>
  </div>

  <div class="search-form__row">
    <div class="form-group">
      <%= f.label :startdatetime, "Departure Date", class: "form-label" %>
      <%= f.date_field :startdatetime, 
          min: Date.today, 
          max: Date.today + 365.days,
          value: params[:startdatetime] || Date.today,
          class: "form-input",
          data: { flight_search_target: "date", action: "change->flight-search#validate" } %>
    </div>

    <div class="form-group">
      <%= f.label :passengers, "Passengers", class: "form-label" %>
      <%= f.select :passengers, @passenger_options,
          { selected: params[:passengers] || 1 },
          { class: "form-select form-input", 
            data: { flight_search_target: "passengers" } } %>
    </div>

    <div class="form-group" style="display: flex; align-items: flex-end;">
      <%= f.submit "Search Flights", 
          class: "btn btn-primary btn-lg btn-full",
          data: { flight_search_target: "submit" } %>
    </div>
  </div>
<% end %>

<!-- Flight Results -->
<turbo-frame id="flight-results">
  <% if @flights.any? %>
    <section class="flights-section">
      <h2 class="flights-section__title">
        <%= pluralize(@flights.count, "flight") %> available
      </h2>

      <%= form_with url: new_booking_path, method: :get, local: true,
                    data: { controller: "flight-select", turbo_frame: "_top" } do %>
        
        <div class="flight-list">
          <% @flights.each_with_index do |flight, index| %>
            <div class="flight-card" 
                 data-flight-select-target="card"
                 data-action="click->flight-select#select">
              
              <div class="flight-card__departure">
                <span class="flight-card__code"><%= flight.departure_airport.airport_code %></span>
                <span class="flight-card__city"><%= flight.departure_airport.airport_name.split(',').first %></span>
                <span class="flight-card__time"><%= flight.startdatetime.strftime("%H:%M") %></span>
              </div>

              <div class="flight-card__route">
                <span class="flight-card__duration"><%= flight.flight_duration %> min</span>
                <div class="flight-card__line">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L2 22M22 2L15 22L11 13L2 9L22 2Z"/>
                  </svg>
                </div>
                <span class="flight-card__duration">Direct</span>
              </div>

              <div class="flight-card__arrival">
                <span class="flight-card__code"><%= flight.arrival_airport.airport_code %></span>
                <span class="flight-card__city"><%= flight.arrival_airport.airport_name.split(',').first %></span>
                <span class="flight-card__time"><%= (flight.startdatetime + flight.flight_duration.minutes).strftime("%H:%M") %></span>
              </div>

              <div class="flight-card__price">
                <span class="flight-card__amount">$<%= rand(150..800) %></span>
                <span class="flight-card__per-person">per person</span>
                <%= radio_button_tag :flight_id, flight.id, index == 0, 
                    class: "flight-card__radio sr-only",
                    data: { flight_select_target: "radio" } %>
              </div>
            </div>
          <% end %>
        </div>

        <%= hidden_field_tag :passengers, params[:passengers] %>
        
        <div class="flex flex-end mt-xl">
          <button type="submit" class="btn btn-primary btn-lg" 
                  data-flight-select-target="submit">
            Continue to Passengers
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      <% end %>
    </section>

  <% elsif params[:departure_airport_id].present? || params[:arrival_airport_id].present? %>
    <section class="flights-section">
      <div class="empty-state">
        <div class="empty-state__icon">✈️</div>
        <h3 class="empty-state__title">No flights found for your search</h3>
        <p class="empty-state__description">
          Try different dates or destinations. Here are some upcoming flights you might like:
        </p>
      </div>

      <h3 class="text-center mt-xl mb-lg">Available Flights</h3>
      
      <%= form_with url: new_booking_path, method: :get, local: true,
                    data: { controller: "flight-select", turbo_frame: "_top" } do %>
        
        <div class="flight-list">
          <% @available_flights.each_with_index do |flight, index| %>
            <div class="flight-card" 
                 data-flight-select-target="card"
                 data-action="click->flight-select#select">
              
              <div class="flight-card__departure">
                <span class="flight-card__code"><%= flight.departure_airport.airport_code %></span>
                <span class="flight-card__city"><%= flight.departure_airport.airport_name.split(',').first %></span>
                <span class="flight-card__time"><%= flight.startdatetime.strftime("%b %d, %H:%M") %></span>
              </div>

              <div class="flight-card__route">
                <span class="flight-card__duration"><%= flight.flight_duration %> min</span>
                <div class="flight-card__line">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L2 22M22 2L15 22L11 13L2 9L22 2Z"/>
                  </svg>
                </div>
                <span class="flight-card__duration">Direct</span>
              </div>

              <div class="flight-card__arrival">
                <span class="flight-card__code"><%= flight.arrival_airport.airport_code %></span>
                <span class="flight-card__city"><%= flight.arrival_airport.airport_name.split(',').first %></span>
                <span class="flight-card__time"><%= (flight.startdatetime + flight.flight_duration.minutes).strftime("%H:%M") %></span>
              </div>

              <div class="flight-card__price">
                <span class="flight-card__amount">$<%= rand(150..800) %></span>
                <span class="flight-card__per-person">per person</span>
                <%= radio_button_tag :flight_id, flight.id, index == 0, 
                    class: "flight-card__radio sr-only",
                    data: { flight_select_target: "radio" } %>
              </div>
            </div>
          <% end %>
        </div>

        <%= hidden_field_tag :passengers, params[:passengers] || 1 %>
        
        <div class="flex flex-end mt-xl">
          <button type="submit" class="btn btn-primary btn-lg" 
                  data-flight-select-target="submit">
            Continue to Passengers
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      <% end %>
    </section>
  <% end %>
</turbo-frame>